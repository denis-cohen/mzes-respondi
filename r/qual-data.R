## ---- Load data ----
dat_qual <- readxl::read_xlsx(paste0("dat/", respondi_xlsx_name),
                              sheet = respondi_sheet_name) %>%
  dplyr::select(
    v_362,
    v_363,
    v_364,
    v_365,
    v_366,
    v_367,
    v_368,
    v_369,
    v_353,
    v_354,
    v_355,
    v_356,
    v_357,
    v_358,
    v_359,
    v_360,
    v_370,
    v_371,
    v_372,
    v_373,
    v_374,
    v_375,
    v_376,
    v_377,
    v_33,
    v_378,
    v_379,
    v_380,
    v_381,
    v_382,
    v_383,
    v_384,
    v_385,
    v_386,
    v_387,
    v_388,
    v_389,
    v_390,
    v_391,
    v_392,
    v_393,
    v_394,
    v_395,
    v_396,
    v_397,
    v_398,
    v_399,
    v_400,
    v_401,
    v_402,
    v_403,
    v_404,
    v_405,
    v_406,
    v_407,
    v_408,
    v_409,
    v_410,
    v_411,
    v_412,
    v_413,
    v_414,
    v_415,
    v_416,
    v_417,
    v_418,
    v_419,
    v_420,
    v_421,
    v_422,
    v_423,
    v_424,
    v_425,
    v_426,
    v_427,
    v_428,
    v_429,
    v_430,
    v_431,
    v_432,
    v_433,
    v_434,
    v_435,
    v_436,
    v_437,
    v_438,
    v_439,
    v_440,
    v_441,
    v_442,
    v_443,
    v_444,
    v_445,
    v_446,
    v_447,
    v_448,
    v_449,
    v_450,
    v_451,
    v_452,
    v_453,
    v_454,
    v_455,
    v_456,
    v_457,
    v_458,
    v_459,
    v_460,
    v_461,
    v_462,
    v_463,
    v_464,
    v_465,
    c_0006,
    lfdn
  ) %>%
  dplyr::mutate_at(vars(-c(c_0006, lfdn)), .funs = ~ dplyr::if_else(. %in% c("-66", "-99"), NA_character_, .)) %>%
  dplyr::rename(
    work_condi_hamper_char1 = v_362,
    work_condi_hamper_char2 = v_363,
    work_condi_hamper_char3 = v_364,
    work_condi_hamper_char4 = v_365,
    work_condi_hamper_char5 = v_366,
    work_condi_hamper_char6 = v_367,
    work_condi_hamper_char7 = v_368,
    work_condi_hamper_char8 = v_369,
    work_condi_improve_char1 = v_353,
    work_condi_improve_char2 = v_354,
    work_condi_improve_char3 = v_355,
    work_condi_improve_char4 = v_356,
    work_condi_improve_char5 = v_357,
    work_condi_improve_char6 = v_358,
    work_condi_improve_char7 = v_359,
    work_condi_improve_char8 = v_360,
    work_atmos_improve_char1 = v_370,
    work_atmos_improve_char2 = v_371,
    work_atmos_improve_char3 = v_372,
    work_atmos_improve_char4 = v_373,
    work_atmos_improve_char5 = v_374,
    work_atmos_improve_char6 = v_375,
    work_atmos_improve_char7 = v_376,
    work_atmos_improve_char8 = v_377,
    covid_neg_other_char = v_33,
    covid_neg_explain_char1 = v_378,
    covid_neg_explain_char2 = v_379,
    covid_neg_explain_char3 = v_380,
    covid_neg_explain_char4 = v_381,
    covid_neg_explain_char5 = v_382,
    covid_neg_explain_char6 = v_383,
    covid_neg_explain_char7 = v_384,
    covid_neg_explain_char8 = v_385,
    covid_support_char1 = v_386,
    covid_support_char2 = v_387,
    covid_support_char3 = v_388,
    covid_support_char4 = v_389,
    covid_support_char5 = v_390,
    covid_support_char6 = v_391,
    covid_support_char7 = v_392,
    covid_support_char8 = v_393,
    covid_suggest_char1 = v_394,
    covid_suggest_char2 = v_395,
    covid_suggest_char3 = v_396,
    covid_suggest_char4 = v_397,
    covid_suggest_char5 = v_398,
    covid_suggest_char6 = v_399,
    covid_suggest_char7 = v_400,
    covid_suggest_char8 = v_401,
    covid_return_char1 = v_402,
    covid_return_char2 = v_403,
    covid_return_char3 = v_404,
    covid_return_char4 = v_405,
    covid_return_char5 = v_406,
    covid_return_char6 = v_407,
    covid_return_char7 = v_408,
    covid_return_char8 = v_409,
    self_explain_char1 = v_410,
    self_explain_char2 = v_411,
    self_explain_char3 = v_412,
    self_explain_char4 = v_413,
    self_explain_char5 = v_414,
    self_explain_char6 = v_415,
    self_explain_char7 = v_416,
    self_explain_char8 = v_417,
    self_conseq_career_explain_char1 = v_418,
    self_conseq_career_explain_char2 = v_419,
    self_conseq_career_explain_char3 = v_420,
    self_conseq_career_explain_char4 = v_421,
    self_conseq_career_explain_char5 = v_422,
    self_conseq_career_explain_char6 = v_423,
    self_conseq_career_explain_char7 = v_424,
    self_conseq_career_explain_char8 = v_425,
    others_suggest_infrastruc_char1 = v_426,
    others_suggest_infrastruc_char2 = v_427,
    others_suggest_infrastruc_char3 = v_428,
    others_suggest_infrastruc_char4 = v_429,
    others_suggest_infrastruc_char5 = v_430,
    others_suggest_infrastruc_char6 = v_431,
    others_suggest_infrastruc_char7 = v_432,
    others_suggest_infrastruc_char8 = v_433,
    others_suggest_prevent_char1 = v_434,
    others_suggest_prevent_char2 = v_435,
    others_suggest_prevent_char3 = v_436,
    others_suggest_prevent_char4 = v_437,
    others_suggest_prevent_char5 = v_438,
    others_suggest_prevent_char6 = v_439,
    others_suggest_prevent_char7 = v_440,
    others_suggest_prevent_char8 = v_441,
    feedback_worker_char1 = v_442,
    feedback_worker_char2 = v_443,
    feedback_worker_char3 = v_444,
    feedback_worker_char4 = v_445,
    feedback_worker_char5 = v_446,
    feedback_worker_char6 = v_447,
    feedback_worker_char7 = v_448,
    feedback_worker_char8 = v_449,
    feedback_equal_char1 = v_450,
    feedback_equal_char2 = v_451,
    feedback_equal_char3 = v_452,
    feedback_equal_char4 = v_453,
    feedback_equal_char5 = v_454,
    feedback_equal_char6 = v_455,
    feedback_equal_char7 = v_456,
    feedback_equal_char8 = v_457,
    comments_char1 = v_458,
    comments_char2 = v_459,
    comments_char3 = v_460,
    comments_char4 = v_461,
    comments_char5 = v_462,
    comments_char6 = v_463,
    comments_char7 = v_464,
    comments_char8 = v_465,
    complete = c_0006
  ) %>%
  dplyr::filter(complete == 1) %>%
  select(-complete)



# Load preprocessed quantitative variables
dat_quan <- readRDS(file = "dat/quant_vars.rds")

# Join quantitative and qualitative data sets (for enforcing filters post-hoc)
dat <- left_join(dat_quan, dat_qual, by = "lfdn")

dat <- dat %>%
  dplyr::rowwise() %>%
  dplyr::mutate_at(
    .vars = vars(dplyr::starts_with(
      c("work_condi_improve_char", "work_atmos_improve_char")
    )),
    .funs = ~ dplyr::if_else(any(!is.na(
      vars(dplyr::starts_with("work_condi_hamper_char"))
    )),
    .,
    NA_character_)
  ) %>%
  dplyr::mutate_at(
    .vars = vars(covid_neg_other_char,
                 dplyr::starts_with("covid_neg_explain_char")),
    .funs = ~ dplyr::if_else(any(!is.na(
      c(
        covid_neg_psych,
        covid_neg_famil,
        covid_neg_equip,
        covid_neg_socia,
        covid_neg_other
      )
    )),
    .,
    NA_character_)
  ) %>%
  dplyr::mutate_at(
    .vars = vars(dplyr::starts_with("self_explain_char")),
    .funs = ~ dplyr::if_else(is.na(self_none) | self_none == 1,
                             NA_character_,
                             .)
  ) %>%
  mutate_at(
    .vars = vars(dplyr::starts_with("self_conseq_career_explain_char")),
    .funs = ~ dplyr::if_else(
      is.na(self_conseq_career) | self_conseq_career == 1,
      NA_character_,
      .
    )
  ) %>%
  mutate_at(
    .vars = vars(
      dplyr::starts_with("others_suggest_infrastruc_char"),
      dplyr::starts_with("others_suggest_prevent_char")
    ),
    .funs = ~ dplyr::if_else(any(!is.na(
      c(
        self_insult,
        self_threat,
        self_molest,
        self_discri,
        self_none,
        others_insult,
        others_threat,
        others_molest,
        others_discri,
        others_none
      )
    )),
    .,
    NA_character_)
  )

## Select qualitative variables from full data
dat_qual <- dat %>%
  dplyr::select(any_of(names(dat_qual)))

## ---- Save ----
saveRDS(dat_qual, file = "dat/qual_vars.rds")
